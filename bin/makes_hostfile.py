#!/usr/bin/env python

"""
Makes a hostfile (nodefile) for MPI to use while running
slice2series. The script reads the nodefile generated by
PBS itself (i.e. after PBS assigns the job the requested
number of nodes) and modifies it to generate a new nodes
file.

"""

import sys
import argparse


parser = argparse.ArgumentParser(prog="{0}".format(__file__))
parser.add_argument('nodesfile', type=str, help='input node file')
parser.add_argument('slots',     type=int, help="Number of (MPI) slots per node")
parser.add_argument('-o',        type=str, help='output node file. Default: Overwrite input file')

args = parser.parse_args()

# Collecting the names of all the unique nodes from the node file
innodes = open(args.nodesfile).readlines()
seen    = set()
uniq_nodes = [ x.strip() for x in innodes if not (x in seen or seen.add(x))]
print("Unique nodes are: {0}".format(uniq_nodes))

if args.o is None:
    outfile = args.nodesfile
else:
    outfile = args.o


ofile = open(outfile, "w")

for node in uniq_nodes:
    ofile.write("{0} slots={1} max_slots={1}\n".format(node, args.slots))

ofile.close()
print("New nodes file written: {0}".format(outfile))